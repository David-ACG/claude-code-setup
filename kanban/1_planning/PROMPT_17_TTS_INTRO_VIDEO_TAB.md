# Prompt: Rebuild TTS Intro Video Tab (Tab 7) with F5-TTS Integration

## Objective

Rebuild the TTS Intro Video tab (Tab 7) from a static mockup into a functional dashboard that:
1. Auto-loads intro scripts generated by the `/write-intro` Claude Code skill
2. Connects to the F5-TTS service on P520 for voice-cloned narration generation
3. Manages voice reference profiles (upload, select, preview)
4. Generates WAV audio files and saves them with pipeline-consistent naming
5. Provides playback, download, and handoff to the Remotion Studio tab (Tab 9)
6. Shows real F5-TTS model status (loaded/unloaded, VRAM usage)

The tab is the **audio generation step** in the lesson pipeline. The `/write-intro` skill produces the narration script (markdown). This tab takes that script, runs it through F5-TTS with a voice reference, and outputs a WAV file that the Remotion Studio tab uses for the final intro video.

**This tab must work with the other dashboard tabs**, not in isolation. The intro script comes from the Lesson Writer tab (Tab 6) / `/write-intro` skill output, and the generated audio feeds into the Remotion Studio tab (Tab 9) for video rendering.

---

## Context: Integration with Other Dashboard Tabs

### Tab-by-Tab Integration

| Tab | Direction | Integration |
|-----|-----------|-------------|
| **Tab 6: Lesson Writer** | ← Input | The Lesson Writer shows intro script content and may offer a "Send to TTS Intro" button. Tab 7 should be able to auto-load intro scripts from `generated_lessons/month*/lesson_*_intro.md` files. When a lesson is selected in the Lesson Writer, Tab 7 should be able to pick up the same lesson's intro script. |
| **Tab 8: TTS Main Text (Kokoro)** | Sibling | Both tabs generate audio but for different purposes. Tab 7 = intro video narration (F5-TTS, voice-cloned, 60-90 seconds). Tab 8 = full lesson text (Kokoro, word timestamps, longer). They share the same `tts_sessions/` output directory but use different naming conventions. |
| **Tab 9: Remotion Studio** | → Output | The generated WAV file is referenced in `slides.json` as `audioFile`. Tab 9's audio sync endpoint reads this WAV to adjust slide timings. The "Send to Remotion" button should make the audio file path available to Tab 9. |
| **Tab 5: Syllabus Manager** | ← Input | Lesson metadata (title, month, number) determines the output filename and voice tone. |

### Shared Data Paths (on P520 in Docker)

| Data | Path | Used By |
|------|------|---------|
| Intro scripts | `/data/generated_lessons/month{N}/lesson_{NN}_intro.md` | Input to this tab |
| Generated audio | `/home/david/gwth-dashboard/tts_sessions/f5_intro_lesson_{NN}.wav` | Output from this tab |
| Voice references | `/home/david/gwth-dashboard/tts_sessions/voice_references/` | Voice profiles for F5-TTS |
| Slides JSON | `/data/generated_lessons/month{N}/lesson_{NN}_slides.json` | References the WAV path in `audioFile` field |

---

## Current State

The TTS Intro Video tab (lines 4909-5001 in `gwth_dashboard.py`) is a static mockup with:
- Hardcoded stats (6 GB VRAM, 3 Voice Profiles, 0 Generated Today, ~2min Avg)
- A text area with placeholder script text
- A voice profile dropdown with 3 hardcoded names
- Generate/Preview buttons that don't work
- A waveform placeholder
- Download WAV / Download MP3 / Send to Remotion buttons — none functional

### F5-TTS Service on P520

- **Health endpoint:** `http://192.168.178.50:5000/health` (already checked by `check_model_status()`)
- **VRAM:** 6.0 GB when loaded
- **GPU:** RTX 3060 12GB (shared with other models)
- **Model status:** Already tracked in the GPU status bar at the top of the dashboard

### F5-TTS API (expected endpoints)

F5-TTS typically exposes:

```
POST /api/generate
Body: {
  "text": "The narration script text...",
  "reference_audio": "/path/to/voice_reference.wav",
  "reference_text": "Transcript of the reference audio..."
}
Response: WAV audio bytes or path to generated file
```

```
GET /health
Response: { "status": "ok", "model_loaded": true }
```

```
POST /api/load
Response: Loads the F5-TTS model into VRAM
```

```
POST /api/unload
Response: Unloads the F5-TTS model from VRAM
```

**Important:** Verify the actual F5-TTS API by checking `http://192.168.178.50:5000/docs` or the F5-TTS documentation. The endpoints above are typical but may differ. The implementation should handle API discovery gracefully.

---

## What the `/write-intro` Skill Does vs What This Tab Does

### `/write-intro` Skill (text generation — runs in Claude Code)

| Responsibility | Detail |
|----------------|--------|
| Read lesson content | Reads the lesson markdown to understand topics, milestones, difficulty |
| Write narration script | 60-90 seconds, 150-220 words, with `[VISUAL: ...]` markers |
| Set tone and style | British, confident, no cringe, matches month difficulty |
| Include Remotion notes | Suggested colour palette, text overlays, visual elements |
| Save intro script file | `generated_lessons/month{N}/lesson_{NN}_intro.md` |

### Tab 7: TTS Intro Video (audio generation — runs in dashboard)

| Responsibility | Detail |
|----------------|--------|
| Load intro scripts | Scan for `lesson_*_intro.md` files, parse script text from markdown |
| Manage voice profiles | Store/select/upload voice reference WAV files (15-30 sec samples) |
| Check F5-TTS status | Query health endpoint, show model loaded/unloaded state |
| Load/unload F5-TTS model | Send load/unload commands to free VRAM when not needed |
| Generate audio | Send script text + voice reference to F5-TTS, receive WAV |
| Audio playback | Play generated WAV in browser with waveform visualisation |
| Save with pipeline naming | Save as `tts_sessions/f5_intro_lesson_{NN}.wav` |
| Hand off to Remotion | Make audio path available for `slides.json` `audioFile` field |
| Track generation history | Show previously generated audio files with metadata |

---

## What to Build

### Part 1: New API Endpoints

Add these endpoints to `gwth_dashboard.py`:

#### `GET /api/tts/f5/status`
Returns F5-TTS service status and available voice profiles.

```json
{
  "model_loaded": true,
  "vram_gb": 6.0,
  "voice_profiles": [
    {"name": "David - Warm Professional", "file": "david_warm.wav", "duration_sec": 22.5},
    {"name": "Alex - Energetic Educator", "file": "alex_energetic.wav", "duration_sec": 18.3}
  ],
  "generated_today": 3,
  "tts_sessions_path": "/home/david/gwth-dashboard/tts_sessions/"
}
```

#### `POST /api/tts/f5/load`
Loads the F5-TTS model into VRAM. Proxies to `http://192.168.178.50:5000/api/load`.

#### `POST /api/tts/f5/unload`
Unloads the F5-TTS model from VRAM. Proxies to `http://192.168.178.50:5000/api/unload`.

#### `POST /api/tts/f5/generate`
Generates audio from script text using F5-TTS.

```json
Request: {
  "script_text": "Most people use ChatGPT like a search engine...",
  "voice_profile": "david_warm.wav",
  "lesson_number": 3,
  "month": 1
}
Response: {
  "status": "success",
  "output_path": "tts_sessions/f5_intro_lesson_03.wav",
  "duration_seconds": 74.5,
  "file_size_mb": 8.2
}
```

This endpoint should:
1. Extract the pure narration text from the script (strip `[VISUAL: ...]` markers and markdown formatting)
2. Send to F5-TTS with the selected voice reference
3. Save output WAV with pipeline naming convention
4. Return metadata about the generated file
5. Run via `asyncio.to_thread()` to prevent UI freezing (generation can take 1-3 minutes)

#### `GET /api/tts/f5/intro-scripts`
Lists available intro scripts from generated lessons.

```json
{
  "scripts": [
    {
      "lesson_number": 3,
      "month": 1,
      "title": "Intro to Large Language Models",
      "file_path": "/data/generated_lessons/month1/lesson_03_intro.md",
      "word_count": 185,
      "estimated_duration_sec": 74,
      "has_audio": true,
      "audio_path": "tts_sessions/f5_intro_lesson_03.wav"
    }
  ]
}
```

#### `GET /api/tts/f5/generated`
Lists previously generated audio files in `tts_sessions/` matching the `f5_intro_*` pattern.

```json
{
  "files": [
    {
      "filename": "f5_intro_lesson_03.wav",
      "lesson_number": 3,
      "file_size_mb": 8.2,
      "duration_seconds": 74.5,
      "created_at": "2026-01-30T14:22:00Z"
    }
  ]
}
```

#### `POST /api/tts/f5/upload-reference`
Upload a voice reference WAV file (15-30 seconds). Saves to `tts_sessions/voice_references/`.

---

### Part 2: Tab 7 UI Rebuild

Replace lines 4909-5001 in `gwth_dashboard.py` with a functional tab.

#### Header Row
- Title: "TTS Intro Video (F5-TTS)"
- F5-TTS status indicator: green/red dot + "Loaded" / "Not Loaded" (from `check_model_status()`)
- "Load Model (6GB)" button → calls `POST /api/tts/f5/load`
- "Unload" button → calls `POST /api/tts/f5/unload`

#### Stats Cards (dynamic)
- **VRAM:** Show actual VRAM when loaded, "Not Loaded" when unloaded
- **Voice Profiles:** Count of WAV files in `tts_sessions/voice_references/`
- **Generated Today:** Count of `f5_intro_*.wav` files created today
- **Avg Generation:** Calculate from recent generation logs (or show "—" if no data)

#### Intro Script Section (left column)

**Lesson selector:** Dropdown populated from `GET /api/tts/f5/intro-scripts`. Each option shows: "Lesson {N}: {title} ({word_count} words)"

**"Load Script" button:** When a lesson is selected:
1. Reads the intro script markdown file
2. Extracts the narration text (everything in `[NARRATION]` blocks, stripping `[VISUAL: ...]` markers)
3. Populates the script textarea
4. Updates the character count and estimated duration

**Script textarea:** Editable text area showing the narration script. User can tweak before generating.
- Character count (live update)
- Word count (live update)
- Estimated duration at 150 words/min

**"Auto-Load from Lesson" button:** Same as Load Script but uses the currently selected lesson from the Lesson Writer tab (if any).

#### Voice Reference Section (left column, below script)

**Voice profile dropdown:** Lists voice reference WAV files from `tts_sessions/voice_references/`. Each shows name and duration.

**Upload button:** File upload for new voice reference (15-30 sec WAV). On upload:
1. Validate: WAV format, 15-30 seconds duration
2. Save to `tts_sessions/voice_references/` with a clean filename
3. Refresh the dropdown

**Preview button:** Play the selected voice reference audio in browser.

#### Generate Audio Section (right column)

**"Generate Intro" button:**
1. Validates: script text not empty, voice profile selected, F5-TTS loaded
2. Shows "Generating..." status with a progress indicator
3. Calls `POST /api/tts/f5/generate`
4. On success: loads the generated audio into the preview player
5. On error: shows error message (e.g., "F5-TTS not loaded — click Load Model first")

**Status display:** Shows generation status (Idle / Generating / Complete / Error) with duration if applicable.

#### Generated Audio Section (right column, below generate)

**Audio player:**
- Waveform visualisation (use a simple canvas-based visualisation or a `<audio>` element with time display)
- Play/Pause button
- Seek slider
- Duration display (current / total)

**Action buttons:**
- **Download WAV** — downloads the generated file
- **Download MP3** — converts to MP3 (via ffmpeg on P520) and downloads
- **Send to Remotion** — copies the audio file path to clipboard or stores it so Tab 9 can reference it. Could also update the lesson's `slides.json` `audioFile` field if the slides JSON exists.

#### Generated Audio History (below main content)

**Table of previously generated audio files:**
- Lesson number
- Filename
- Duration
- File size
- Date generated
- Play button (inline)
- Use button (loads into the preview player)

---

## Important Implementation Notes

### JavaScript Escaping
The dashboard uses `HTML_TEMPLATE = """..."""` triple-quoted Python strings. Inside these:
- Use `\\n` not `\n` for JavaScript newlines
- Use `\\x27` not `\'` for single quotes in JS onclick handlers
- This has broken the dashboard multiple times — be careful

### NiceGUI 3.x Patterns
- Use `ui.html(content, sanitize=False)` for raw HTML
- Use `ui.add_body_html('''<script>...</script>''')` for JavaScript
- Tab panels are lazy-rendered — content may not exist in DOM until the tab is clicked
- Use `asyncio.to_thread()` for long-running synchronous calls (F5-TTS generation!) to prevent UI freezing
- File uploads use `ui.upload()` with `on_upload` handler

### F5-TTS API Discovery
The actual F5-TTS API endpoints on P520 may differ from the typical ones listed above. Before implementing:
1. Check `http://192.168.178.50:5000/docs` for API documentation
2. Test with `curl http://192.168.178.50:5000/health`
3. The dashboard already checks this endpoint in `check_model_status()` (line 123: `f'http://{host_ip}:5000/health'`)

### Script Text Extraction
The `/write-intro` skill outputs markdown with `[VISUAL: ...]` markers and `[NARRATION]` labels. The tab needs to:
1. Parse the markdown to extract only the narration text
2. Strip `[VISUAL: ...]` lines (these are for Remotion, not TTS)
3. Strip `[NARRATION]` labels
4. Join remaining text into a clean script for F5-TTS

Example input:
```markdown
[VISUAL: Title card with lesson number and title]
[NARRATION]
Most people use ChatGPT like a search engine. That's leaving about 90% of its capability on the table.

[VISUAL: Key concept graphic]
[NARRATION]
In this lesson, you'll learn how to...
```

Expected extracted text:
```
Most people use ChatGPT like a search engine. That's leaving about 90% of its capability on the table. In this lesson, you'll learn how to...
```

### Audio File Naming Convention
Generated audio files should follow the pattern: `f5_intro_lesson_{NN}.wav` where `{NN}` is zero-padded to 2 digits (e.g., `f5_intro_lesson_03.wav`). This matches what the `/write-slides` skill expects in the `audioFile` field of `slides.json`.

### VRAM Management
The RTX 3060 has 12GB VRAM shared across all models. F5-TTS requires 6GB. The Load/Unload buttons let users manage VRAM:
- If Docling (2.5GB) + Qdrant (0GB, CPU) + Whisper (3.0GB) are loaded, F5-TTS may not fit
- Show a warning if available VRAM is insufficient when user clicks "Load Model"
- The GPU status bar at the top of the dashboard already shows VRAM usage

### Error Handling
- If F5-TTS is not loaded: show clear "Load Model first" message
- If voice reference is missing: prompt to upload one
- If script is too long (>220 words): show warning but allow generation
- If generation fails: show error from F5-TTS API response
- If audio file already exists: ask to overwrite or create versioned filename

---

## Files to Modify

| File | Action | Purpose |
|------|--------|---------|
| `app/gwth_dashboard.py` lines 4909-5001 | REPLACE | Rebuild TTS Intro Video tab |
| `app/gwth_dashboard.py` (new endpoint section) | ADD | `/api/tts/f5/*` endpoints |

---

## Acceptance Criteria

1. **F5-TTS status is live** — The tab shows whether F5-TTS is loaded or not, matching the GPU status bar. Load/Unload buttons work.

2. **Intro scripts auto-load** — Selecting a lesson from the dropdown loads the narration text from the intro script markdown, stripping visual markers.

3. **Voice profiles work** — User can select from existing voice references and upload new ones (15-30 sec WAV).

4. **Audio generation works** — Clicking "Generate Intro" sends the script to F5-TTS and produces a WAV file saved with the correct naming convention.

5. **Audio playback works** — Generated audio can be played back in the browser with seek/duration controls.

6. **Download works** — WAV download works. MP3 conversion and download works (via ffmpeg).

7. **Send to Remotion works** — The generated audio path is made available for Tab 9 (Remotion Studio). If a `slides.json` exists for this lesson, the `audioFile` field is updated.

8. **Stats are dynamic** — Voice profile count, generated today count, and VRAM display all reflect actual state.

9. **Generation history shows** — Previously generated audio files are listed with metadata and can be replayed.

10. **No UI freeze** — Audio generation runs in a background thread via `asyncio.to_thread()`. The UI remains responsive during the 1-3 minute generation time.

11. **Cross-tab integration** — Intro scripts generated by `/write-intro` (via Lesson Writer tab) are automatically discoverable. Audio files are automatically discoverable by the Remotion Studio tab.

---

## Testing Approach

1. Check F5-TTS health: `curl http://192.168.178.50:5000/health`
2. Check F5-TTS API docs: `curl http://192.168.178.50:5000/docs`
3. Create a test intro script manually in `generated_lessons/month1/lesson_01_intro.md`
4. Test script loading and text extraction
5. Test voice reference upload
6. Test audio generation with a short script (~50 words)
7. Test playback and download
8. Test the full flow: load script → select voice → generate → play → send to Remotion
